<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPS 测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    #startButton {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .timeButton {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
    }
    #clickArea {
      width: 300px;
      height: 200px;
      background-color: #f0f0f0;
      margin: 20px auto;
      text-align: center;
      line-height: 200px;
      border: 1px solid #ccc;
    }
    #result {
      font-size: 20px;
      margin-top: 20px;
    }
    #clickCount {
      font-size: 18px;
      margin-top: 20px;
    }
    #countdown {
      font-size: 24px;
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
<h1>CPS 测试</h1>
<p>选择测试时长，然后开始测试。</p>

<div>
  <button class="timeButton" data-duration="5">5秒</button>
  <button class="timeButton" data-duration="10">10秒</button>
  <button class="timeButton" data-duration="15">15秒</button>
</div>

<div>
  <button id="startButton" disabled>开始测试</button>
</div>

<div id="clickArea">点击这里！</div>
<p id="clickCount">点击次数：0</p>
<p id="countdown">剩余时间：0</p>
<p id="result"></p>

<script>
  let clickCount = 0;
  let startTime = 0;
  let testDuration = 0;  // 动态设置测试时长
  let cps = 0;           // 平滑的CPS值
  let lastClickTime = 0;
  let decayFactor = 0.98; // 衰减因子，决定没有点击时CPS衰减的速度
  let updateInterval = 100; // 更新CPS的时间间隔，单位为毫秒
  let countdownInterval; // 倒计时更新的定时器
  let cpsInterval; // 用于更新CPS的定时器

  const startButton = document.getElementById("startButton");
  const clickArea = document.getElementById("clickArea");
  const result = document.getElementById("result");
  const clickCountElement = document.getElementById("clickCount");
  const countdownElement = document.getElementById("countdown");
  const timeButtons = document.querySelectorAll(".timeButton");

  // 为每个时间按钮添加事件监听
  timeButtons.forEach(button => {
    button.addEventListener("click", (e) => {
      testDuration = parseInt(e.target.dataset.duration);
      console.log("选择的时间：",testDuration);
      startButton.disabled = false;  // 启用“开始测试”按钮
      result.textContent = `选择了 ${testDuration} 秒的测试时长。`;
    });
  });

  startButton.addEventListener("click", startTest);
  clickArea.addEventListener("click", registerClick);

  function startTest() {
    // 重置测试
    clickCount = 0;
    cps = 0;
    lastClickTime = Date.now();
    result.textContent = "";
    clickCountElement.textContent = `点击次数：${clickCount}`; // 初始化点击次数
    countdownElement.textContent = `剩余时间：${testDuration}`;
    startButton.disabled = true;
    startTime = Date.now();
    clickArea.textContent = "开始点击！"; // 提示开始点击

    // 启动倒计时
    let timeRemaining = testDuration;
    countdownInterval = setInterval(() => {
      timeRemaining--;
      countdownElement.textContent = `剩余时间：${timeRemaining}`;
      if (timeRemaining <= 0) {
        clearInterval(countdownInterval);  // 停止倒计时
        endTest();  // 结束测试
      }
    }, 1000);

    // 启动CPS更新
    cpsInterval = setInterval(updateCPS, updateInterval);
  }

  function registerClick() {
    clickCount++;
    lastClickTime = Date.now(); // 记录最后一次点击时间
    clickCountElement.textContent = `点击次数：${clickCount}`; // 更新点击次数
  }

  function updateCPS() {
    // 计算从上次点击到现在经过的时间，单位为秒
    const elapsedTimeSinceLastClick = (Date.now() - lastClickTime) / 1000;

    // 衰减CPS，避免数值快速下降
    if (elapsedTimeSinceLastClick > 1) {
      cps *= decayFactor;  // CPS逐渐减小
    } else {
      // 如果有点击，CPS恢复
      cps = clickCount / ((Date.now() - startTime) / 1000);
    }

    result.textContent = `当前CPS：${cps.toFixed(2)}次/秒`;
  }

  function endTest() {
    // 停止更新CPS
    clearInterval(cpsInterval);

    // 结束时显示最终结果
    const endTime = Date.now();
    const elapsedTime = (endTime - startTime) / 1000; // 计算秒数
    const finalCPS = (clickCount / elapsedTime).toFixed(2);
    result.textContent = `测试结束！你在${elapsedTime}秒内点击了${clickCount}次，平均CPS是：${finalCPS}次/秒。`;
    clickArea.textContent = "测试结束";
    startButton.disabled = false;
  }
</script>
</body>
</html>
